(()=>{"use strict";window.util={getRandomInt:function(e,t){return Math.floor(Math.random()*(t-e))+e},getRandomInRange:function(e,t){return Math.floor(Math.random()*(t-e+1))+e},errorHandler:function(e){let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}},window.backend={load:function(e,t){let n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(function(){200===n.status?e(n.response):t&&t("Статус ответа: "+n.status+" "+n.statusText)})),t&&(n.addEventListener("error",(function(){t("Произошла ошибка соединения")})),n.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+n.timeout+"мс")}))),n.timeout=1e4,n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},save:function(e,t,n){let o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(function(){200===o.status?t(o.response):n&&n("Статус ответа: "+o.status+" "+o.statusText)})),n&&(o.addEventListener("error",(function(){n("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){n("Запрос не успел выполниться за "+o.timeout+"мс")}))),o.timeout=1e4,o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)}},(()=>{const e=document.getElementById("title"),t=document.getElementById("price"),n=document.getElementById("type"),o=document.getElementById("timein"),r=document.getElementById("timeout"),i=document.getElementById("room_number"),d=document.getElementById("capacity"),c=d.querySelectorAll("option"),l=document.querySelector(".ad-form"),a=document.getElementById("description"),s=document.querySelector("#success").content.querySelector(".success"),u=document.querySelector("#error").content.querySelector(".error"),f=document.querySelector(".error__button"),m=document.querySelector("main"),p=document.querySelector(".features"),y=document.querySelector(".ad-form-header__input"),v=document.querySelector(".ad-form-header__avatar"),h=document.querySelector(".ad-form__input"),g=document.querySelector(".ad-form-flat__photo"),w="flat",E=["gif","jpg","jpeg","png"],_={avatar:v.src,flat:g.src};y.addEventListener("change",(function(){let e=y.files[0],t=e.name.toLowerCase();if(E.some((function(e){return t.endsWith(e)}))){let t=new FileReader;t.addEventListener("load",(function(){v.src=t.result})),t.readAsDataURL(e)}})),h.addEventListener("change",(function(){let e=h.files[0],t=e.name.toLowerCase();if(E.some((function(e){return t.endsWith(e)}))){let t=new FileReader;t.addEventListener("load",(function(){g.src=t.result})),t.readAsDataURL(e)}})),i.addEventListener("change",(function(){x()})),d.addEventListener("change",(function(){x()}));let x=function(){L(i.selectedIndex)},L=function(e){for(let t=0;t<c.length;t++)switch(e){case 0:c[t].disabled=2!==t;break;case 1:c[t].disabled=2!==t&&1!==t;break;case 2:c[t].disabled=3===t;break;case 3:c[t].disabled=3!==t}if(c[d.selectedIndex].disabled)for(let e=0;e<c.length;e++)if(!c[e].disabled){d.selectedIndex=e;break}};o.addEventListener("change",(function(){r.selectedIndex=o.selectedIndex})),r.addEventListener("change",(function(){o.selectedIndex=r.selectedIndex}));let b=function(){e.validity.valueMissing?e.setCustomValidity("Обязательное поле"):e.validity.tooLong||e.validity.tooShort?e.setCustomValidity("Длина символов должна быть от 30 до 100!"):e.setCustomValidity("")},k=function(){t.validity.valueMissing?t.setCustomValidity("Обязательное поле"):t.validity.typeMismatch?t.setCustomValidity("Ввдено не число!"):t.validity.rangeOverflow?t.setCustomValidity("Введено больше 1000000!"):t.setCustomValidity("")};e.addEventListener("invalid",(function(){b()})),t.addEventListener("invalid",(function(){k()})),t.addEventListener("input",(function(){k()})),e.addEventListener("input",(function(){b()})),n.addEventListener("change",(function(){S()}));let S=function(){switch(n.value){case"bungalow":t.min=0,t.placeholder=t.min;break;case w:t.min=1e3,t.placeholder=t.min;break;case"house":t.min=5e3,t.placeholder=t.min;break;case"palace":t.min=1e4,t.placeholder=t.min}};l.addEventListener("submit",(function(e){window.backend.save(new FormData(l),I,C),e.preventDefault()}));let q=function(){e.value="",t.value=1e3,t.placeholder=t.value,n.value=w,o.selectedIndex=0,r.selectedIndex=0,i.selectedIndex=0,d.selectedIndex=2,L(i.selectedIndex),a.value="";for(let e=0;e<p.children.length;e++)!0===p.children[e].checked&&(p.children[e].checked=!1);p.disabled=!0,v.src=_.avatar,g.src=_.flat,y.value="",h.value=""},I=function(){window.map.disableForm(),q();let e=s.cloneNode(!0);m.appendChild(e);let t=function(){o()},n=function(e){"Escape"===e.key&&o()},o=function(){m.removeChild(e),document.removeEventListener("click",t),document.removeEventListener("keydown",n)};document.addEventListener("click",t),document.addEventListener("keydown",n)},C=function(){window.map.disableForm(),q();let e=u.cloneNode(!0);m.appendChild(e),f.addEventListener("click",(function(e){e.preventDefault(),o()}));let t=function(){o()},n=function(e){"Escape"===e.key&&o()},o=function(){m.removeChild(e),document.removeEventListener("click",t),document.removeEventListener("keydown",n)};document.addEventListener("click",t),document.addEventListener("keydown",n)};window.card={clearCard:q},o.selectedIndex=r.selectedIndex,S(),x()})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),t=e.querySelector(".popup__close"),n=document.querySelector(".map"),o={bungalow:"Бунгало",flat:"Квартира",house:"Дом",palace:"Дворец"};document.addEventListener("keydown",(function(e){"Escape"===e.key&&r(e)})),t.addEventListener("click",(function(e){r(e)}));let r=function(t){t.preventDefault(),e.style.display="none"};window.cardDeatail={pinOnClickHandler:function(t,r){t.addEventListener("click",(function(t){t.preventDefault(),e.style.display="",e.querySelector(".popup__avatar").src=r.author.avatar,e.querySelector(".popup__title").textContent=r.offer.title,e.querySelector(".popup__text--address").textContent=r.offer.address,e.querySelector(".popup__text--price").textContent=r.offer.price+"₽/ночь",e.querySelector(".popup__type").textContent=void 0!==r.offer.type&&void 0!==o[r.offer.type]?o[r.offer.type]:"";let i=e.querySelector(".popup__text--capacity");0===r.offer.rooms&&0===r.offer.guests?i.style.visibility="hidden":i.style.visibility="visible",i.textContent=`${r.offer.rooms} комнаты для ${r.offer.guests} гостей`;let d=e.querySelector(".popup__text--time");"0:00"===r.offer.checkin&&"0:00"===r.offer.checkout?d.style.visibility="hidden":d.style.visibility="visible",d.textContent=`Заезд после ${r.offer.checkin}, выезд до ${r.offer.checkout}`;let c=e.querySelector(".popup__features");for(let e=c.children.length-1;e>=0;e--)void 0!==r.offer.features&&r.offer.features.some((t=>c.children[e].className.indexOf(t)>-1))?c.children[e].style.display="":c.children[e].style.display="none";e.querySelector(".popup__description").textContent=r.offer.description;let l=e.querySelector(".popup__photos");for(;l.firstChild;)l.firstChild.remove();let a=document.createDocumentFragment();for(let e=0;e<r.offer.photos.length;e++){let t=document.createElement("img");t.className="popup__photo",t.src=r.offer.photos[e],t.width=45,t.height=40,a.appendChild(t)}l.appendChild(a),n.appendChild(e)}))},clearCardDeatail:function(){e.style.display="none"}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins");let n=function(t){let n=e.cloneNode(!0);n.style=`left: ${t.location.x}px; top: ${t.location.y}px;`;for(let e=0;e<n.children.length;e++)void 0!==n.children[e].src&&(n.children[e].src=t.author.avatar,n.children[e].alt="Заголовок объявления");return n},o=document.createDocumentFragment();window.pinRender={drowPins:function(e){for(let t=0;t<e.length;t++){let r=n(e[t]);window.cardDeatail.pinOnClickHandler(r,e[t]),o.appendChild(r)}t.appendChild(o)},clear:function(){window.cardDeatail.clearCardDeatail();let e=t.querySelectorAll(".map__pin");for(let t=e.length-1;t>0;t--)"map__pin map__pin--main"!==e[t].className&&e[t].remove()}}})(),(()=>{let e=null;window.debounce=function(t){return function(...n){e&&window.clearTimeout(e),e=window.setTimeout((function(){t(...n)}),500)}}})(),(()=>{const e=document.getElementById("housing-type"),t=document.getElementById("housing-price"),n=document.getElementById("housing-rooms"),o=document.getElementById("housing-guests"),r=document.getElementById("housing-features"),i=r.querySelectorAll("input");let d=[];let c=function(){};e.addEventListener("change",(function(){l()})),t.addEventListener("change",(function(){l()})),n.addEventListener("change",(function(){l()})),o.addEventListener("change",(function(){l()})),r.addEventListener("change",(function(){l()}));let l=function(){let r=0,l=d.filter((function(){return r++,r<=5}));l=l.slice().filter((function(t){return"any"===e.value||void 0!==t.offer&&t.offer.type===e.value})),l=l.slice().filter((function(e){if(0===o.selectedIndex)return!0;if(void 0===e.offer||void 0===e.offer.guests)return!1;switch(o.selectedIndex){case 1:return e.offer.guests>=2;case 2:return e.offer.guests>=1;case 3:return 0===e.offer.guests;default:return!0}})),l=l.slice().filter((function(e){if(0===n.selectedIndex)return!0;if(void 0===e.offer||void 0===e.offer.rooms)return!1;switch(n.selectedIndex){case 1:return 1===e.offer.rooms;case 2:return 2===e.offer.rooms;case 3:return 3===e.offer.rooms;default:return!0}})),l=l.slice().filter((function(e){if(0===t.selectedIndex)return!0;if(void 0===e.offer||void 0===e.offer.price)return!1;switch(t.selectedIndex){case 1:return e.offer.price>=1e4&&e.offer.price<5e4;case 2:return e.offer.price<1e4;case 3:return e.offer.price>=5e4;default:return!0}}));for(let e=0;e<i.length;e++)!0===i[e].checked&&(l=l.filter((function(t){return void 0!==t.offer.features&&t.offer.features.some((t=>t===i[e].value))})));window.debounce((function(){c(l)}))()};window.filters={getFilteredData:function(e,t){d=e,c=t,l()}}})(),(()=>{const e=document.querySelector(".map__pin.map__pin--main"),t=document.querySelectorAll(".ad-form__element"),n=document.querySelectorAll(".map__filter"),o=document.querySelector(".map__features").querySelectorAll("input"),r=document.querySelector(".ad-form__reset"),i=document.getElementById("address");let d=!1,c=[];const l=document.querySelectorAll("fieldset"),a=document.body.offsetWidth,s={X0:e.style.left,Y0:e.style.top},u={Xmin:-20,Xmax:a-20,Ymin:90,Ymax:590};e.onmousedown=function(t){const n=t.clientX-parseInt(e.style.left,10),o=t.clientY-parseInt(e.style.top,10)+window.pageYOffset;function r(t){!function(t,r){let i=t-n+32.5,d=r-o+87;i<=a&&i>=0&&(e.style.left=t-n+"px"),d<=630&&d>=130&&(e.style.top=r-o+"px"),p()}(t.pageX,t.pageY)}e.style.position="absolute",e.style.zIndex=1e3,1===t.which&&(f(),document.addEventListener("mousemove",r),document.onmouseup=function(){document.removeEventListener("mousemove",r)})},e.addEventListener("keydown",(function(e){"Enter"===e.key&&f()}));let f=function(){if(!d){d=!0,window.filters.getFilteredData(c,h),m(!1),p(),i.readOnly=!0,document.querySelector(".map").classList.remove("map--faded"),document.querySelector(".ad-form").classList.remove("ad-form--disabled");for(let e=0;e<l.length;e++)l[e].disabled=!1}},m=function(e){for(let n=0;n<t.length;n++)t[n].disabled=e;for(let t=0;t<n.length;t++)n[t].disabled=e},p=function(){i.value=`${Math.round(parseInt(e.style.left,10)+32.5)}, ${Math.round(parseInt(e.style.top,10)+87)}`};function y(){v(),d=!1,document.querySelector(".map").classList.add("map--faded"),document.querySelector(".ad-form").classList.add("ad-form--disabled"),m(!0),window.pinRender.clear(),e.style.left=s.X0,e.style.top=s.Y0,p();for(let e=0;e<l.length;e++)l[e].disabled=!0;for(let e=0;e<o.length;e++)!0===o[e].checked&&(o[e].checked=!1);window.card.clearCard()}window.backend.load((function(e){c=e}),window.util.errorHandler);let v=function(){for(let e=0;e<n.length;e++)n[e].selectedIndex=0};window.map={disableForm:y};const h=function(e){window.pinRender.clear();for(let t=0;t<e.length;t++)e[t].location.x+20>a&&(e[t].location.x=u.Xmax),e[t].location.x+20<0&&(e[t].location.x=u.Xmin),e[t].location.y+40<130&&(e[t].location.y=u.Ymin),e[t].location.y+40>630&&(e[t].location.y=u.Ymax);window.pinRender.drowPins(e)};r.addEventListener("click",(function(e){y(),e.preventDefault()}))})(),window.map.disableForm()})();